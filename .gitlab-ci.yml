# GitLab CI/CD Pipeline for IFO
# Builds cross-platform binaries and creates releases on git tags

# Use official Rust image
image: rust:latest

# Define pipeline stages
stages:
  - lint
  - test
  - build
  - release

# Cache cargo dependencies for faster builds
variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .cargo/
    - target/

# Only run pipeline on git tags matching v* (e.g., v2.0.0)
workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

# ============================================================================
# LINT STAGE
# ============================================================================

fmt-check:
  stage: lint
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check
  allow_failure: false

clippy:
  stage: lint
  script:
    - rustup component add clippy
    - cargo clippy --all-targets --all-features -- -D warnings
  allow_failure: false

# ============================================================================
# TEST STAGE
# ============================================================================

test:
  stage: test
  script:
    - cargo test --all-features --verbose
  coverage: '/^\s*lines\.+:\s+(\d+\.\d+)%/'

# ============================================================================
# BUILD STAGE - Cross-platform binaries
# ============================================================================

# Template for macOS builds (using zig cross-compiler)
.build_macos_template: &build_macos_template
  stage: build
  before_script:
    # Install dependencies for zig
    - apt-get update && apt-get install -y wget xz-utils
    # Install zig (required for cargo-zigbuild)
    - wget -q https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz
    - tar -xf zig-linux-x86_64-0.13.0.tar.xz
    - export PATH="$PWD/zig-linux-x86_64-0.13.0:$PATH"
    # Install cargo-zigbuild
    - cargo install cargo-zigbuild
    - export PATH="$CARGO_HOME/bin:$PATH"
  artifacts:
    paths:
      - binaries/
    expire_in: 1 week

# Template for Windows builds (using zig cross-compiler)
.build_windows_template: &build_windows_template
  stage: build
  before_script:
    # Install dependencies for zig and MinGW toolchain
    - apt-get update && apt-get install -y wget xz-utils mingw-w64
    # Install zig (required for cargo-zigbuild)
    - wget -q https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz
    - tar -xf zig-linux-x86_64-0.13.0.tar.xz
    - export PATH="$PWD/zig-linux-x86_64-0.13.0:$PATH"
    # Install cargo-zigbuild
    - cargo install cargo-zigbuild
    - export PATH="$CARGO_HOME/bin:$PATH"
  artifacts:
    paths:
      - binaries/
    expire_in: 1 week

build-linux-x86_64:
  stage: build
  script:
    # Native build (we're already on Linux x86_64)
    - cargo build --release
    - mkdir -p binaries
    - cp target/release/ifo binaries/ifo-linux-x86_64
    - chmod +x binaries/ifo-linux-x86_64
  artifacts:
    paths:
      - binaries/
    expire_in: 1 week

build-macos-x86_64:
  <<: *build_macos_template
  script:
    - rustup target add x86_64-apple-darwin
    - cargo zigbuild --release --target x86_64-apple-darwin
    - mkdir -p binaries
    - cp target/x86_64-apple-darwin/release/ifo binaries/ifo-macos-x86_64
    - chmod +x binaries/ifo-macos-x86_64

build-macos-aarch64:
  <<: *build_macos_template
  script:
    - rustup target add aarch64-apple-darwin
    - cargo zigbuild --release --target aarch64-apple-darwin
    - mkdir -p binaries
    - cp target/aarch64-apple-darwin/release/ifo binaries/ifo-macos-aarch64
    - chmod +x binaries/ifo-macos-aarch64

build-windows-x86_64:
  <<: *build_windows_template
  script:
    - rustup target add x86_64-pc-windows-gnu
    - cargo zigbuild --release --target x86_64-pc-windows-gnu
    - mkdir -p binaries
    - cp target/x86_64-pc-windows-gnu/release/ifo.exe binaries/ifo-windows-x86_64.exe

# ============================================================================
# RELEASE STAGE - Package and publish
# ============================================================================

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build-linux-x86_64
      artifacts: true
    - job: build-macos-x86_64
      artifacts: true
    - job: build-macos-aarch64
      artifacts: true
    - job: build-windows-x86_64
      artifacts: true
  before_script:
    - apk add --no-cache bash tar gzip zip coreutils
  script:
    - cd binaries

    # Create compressed archives for Unix platforms
    - tar -czf ifo-${CI_COMMIT_TAG}-linux-x86_64.tar.gz ifo-linux-x86_64
    - tar -czf ifo-${CI_COMMIT_TAG}-macos-x86_64.tar.gz ifo-macos-x86_64
    - tar -czf ifo-${CI_COMMIT_TAG}-macos-aarch64.tar.gz ifo-macos-aarch64

    # Create zip archive for Windows
    - zip ifo-${CI_COMMIT_TAG}-windows-x86_64.zip ifo-windows-x86_64.exe

    # Generate SHA256 checksums
    - sha256sum ifo-${CI_COMMIT_TAG}-*.tar.gz ifo-${CI_COMMIT_TAG}-*.zip > SHA256SUMS.txt
    - cat SHA256SUMS.txt

    - cd ..
  artifacts:
    paths:
      - binaries/*.tar.gz
      - binaries/*.zip
      - binaries/SHA256SUMS.txt
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'IFO $CI_COMMIT_TAG'
    description: 'Blazing-fast Rust CLI for querying real-time aircraft data worldwide. Download the appropriate binary for your platform from the assets below. See https://gitlab.com/arnops/ifo/-/blob/main/README.md for installation instructions.'
    assets:
      links:
        - name: 'Linux x86_64'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/binaries/ifo-${CI_COMMIT_TAG}-linux-x86_64.tar.gz'
          link_type: 'package'
        - name: 'macOS Intel (x86_64)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/binaries/ifo-${CI_COMMIT_TAG}-macos-x86_64.tar.gz'
          link_type: 'package'
        - name: 'macOS Apple Silicon (aarch64)'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/binaries/ifo-${CI_COMMIT_TAG}-macos-aarch64.tar.gz'
          link_type: 'package'
        - name: 'Windows x86_64'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/binaries/ifo-${CI_COMMIT_TAG}-windows-x86_64.zip'
          link_type: 'package'
        - name: 'SHA256 Checksums'
          url: '${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/binaries/SHA256SUMS.txt'
          link_type: 'other'
